	.include "common.h"
	@(その他必要な定数を定義する)
	.section .init
	.global music
music:
	mov	r3, #0
	mov	r6, #0
mstart:	
	mov	r2, #0		@ index
SW1:
	ldr	r0, =GPIO_BASE
	@ SW1押してるかどうか(押すとサイクロップス先輩に襲われる)
	ldr     r1, [r0, #GPLEV0]
	and	r1, #(1 << SW1_PORT)
	cmp	r1, #(1 << SW1_PORT)
	bne	SW2
	@ SW1押してる
	ldr	r0, =PWM_BASE
	mov	r1, #0
	str    	r1, [r0, #PWM_DAT2]	@ 音を止める
	mov	r6, #0
	str     r14, [sp, #-4]!    @ push r14
	bl	screen
	ldr     r14, [sp], #4      @ pop r14
	ldr	r3, =sand
	ldr	r6, =120000
	b	mstart
SW2:
	@ SW2押してるかどうか(押すとバジリスクタイムになる)
	ldr     r1, [r0, #GPLEV0]
	and	r1, #(1 << SW2_PORT)
	cmp	r1, #(1 << SW2_PORT)
	bne	SW3
	@ SW2押してる
	ldr	r0, =PWM_BASE
	mov	r1, #0
	str    	r1, [r0, #PWM_DAT2]	@ 音を止める
	mov	r6, #0
	str     r14, [sp, #-4]!    @ push r14
	bl	screen
	ldr     r14, [sp], #4      @ pop r14
	ldr	r3, =bazi
	ldr	r6, =150000
	b	mstart
SW3:
	@ SW3押してるかどうか(押すと変態糞土方がやってくる)
	ldr     r1, [r0, #GPLEV0]
	and	r1, #(1 << SW3_PORT)
	cmp	r1, #(1 << SW3_PORT)
	bne	SW4
	@ SW3押してる
	ldr	r0, =PWM_BASE
	mov	r1, #0
	str    	r1, [r0, #PWM_DAT2]	@ 音を止める
	mov	r6, #0
	str     r14, [sp, #-4]!    @ push r14
	bl	screen
	ldr     r14, [sp], #4      @ pop r14
	ldr	r3, =mon
	ldr	r6, =200000
	b	mstart
SW4:
	@ SW4押してるかどうか(押しても止まるんじゃねぇぞ…)
	ldr     r1, [r0, #GPLEV0]
	and	r1, #(1 << SW4_PORT)
	cmp	r1, #(1 << SW4_PORT)
	bne	mrun
	@ SW4押してる
	ldr	r0, =PWM_BASE
	mov	r1, #0
	str    	r1, [r0, #PWM_DAT2]	@ 音を止める
	mov	r6, #0
	str     r14, [sp, #-4]!    @ push r14
	bl	screen
	ldr     r14, [sp], #4      @ pop r14
	ldr	r3, =rage
	ldr	r6, =60000
	b	mstart
	@********************************
mrun:
	str     r14, [sp, #-4]!    @ push r14
	bl	screen
	ldr     r14, [sp], #4      @ pop r14
	cmp	r3, #0
	beq	mstart
	ldrb	r1, [r3, r2]	@ 周波数
	add	r2, r2, #1
	ldrb	r4, [r3, r2]	@ 長さ
	add	r2, r2, #1
	mov	r5, #10
	mul	r1, r5, r1	@ 正しい周波数
	ldr	r5, =PWM_HZ
	udiv	r1, r5, r1	@ PWM_HZ / 周波数
	cmp	r4, #0
	beq	mend 
	bl	sound
	b	SW1

	@ ********** おしまい **********
mend:
	ldr	r0, =PWM_BASE
	mov	r1, #0
	str    	r1, [r0, #PWM_DAT2]	@ 音を止める
	b	music
	@ ********** サブルーチン **********

sound:
	ldr	r0, =PWM_BASE
	cmp	r1, #0
	strne	r1, [r0, #PWM_RNG2]
	lsr	r1, r1, #1
	str	r1, [r0, #PWM_DAT2]
	@ 待ち時間
	ldr	r0, =TIMER_BASE
	ldr	r1, [r0, #TIMER_LOW]
	mul	r4, r6, r4
	add	r1, r1, r4, lsr	#1
1:
	ldr	r0, =TIMER_BASE
	ldr	r4, [r0, #TIMER_LOW]
	@ 割り込み処理ここに
	str     r14, [sp, #-4]!    @ push r14
	bl	screen
	ldr     r14, [sp], #4      @ pop r14
	cmp	r1, r4
	bhs	1b		@ r1 >= r4
	bx	r14
	
	@   全音符 32
	@  2分音符 16
	@  4分音符  8
	@  8分音符  4
	@ 16分音符  2 
	@ 32分音符  1
	@ 16分連続同じ音: 32分鳴らして32分とめる
sand:
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	.byte E5, 1, 0, 1, E5, 1, 0, 1, E5, 1, 0, 1, E5, 1, 0, 1, E5, 2, 0, 2, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 2, 0, 2, A4, 1, 0, 1, A4, 1, 0, 1
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	.byte E5, 1, 0, 1, E5, 1, 0, 1, E5, 1, 0, 1, E5, 1, 0, 1, E5, 2, 0, 2, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 2, 0, 2, A4, 1, 0, 1, A4, 1, 0, 1
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	.byte E5, 1, 0, 1, E5, 1, 0, 1, E5, 1, 0, 1, E5, 1, 0, 1, E5, 2, 0, 2, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 2, 0, 2, A4, 1, 0, 1, A4, 1, 0, 1
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	.byte E5, 1, 0, 1, E5, 1, 0, 1, E5, 1, 0, 1, E5, 1, 0, 1, E5, 2, 0, 2, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 2, 0, 2, A4, 1, 0, 1, A4, 1, 0, 1
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, D5, 2, 0, 2
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, D5, 2, 0, 2, D5, 2, 0, 2
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	.byte E5, 1, 0, 1, E5, 1, 0, 1, E5, 2, 0, 2, E5, 2, 0, 2, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 2, 0, 2, D5, 2, 0, 2, A4, 1, 0, 1, A4, 1, 0, 1
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, D5, 2, 0, 2
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, D5, 2, 0, 2, D5, 2, 0, 2
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, E5, 1, 0, 1, E5, 1, 0, 1
	.byte E5, 1, 0, 1, E5, 1, 0, 1, E5, 2, 0, 2, E5, 2, 0, 2, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 1, 0, 1, D5, 2, 0, 2, D5, 2, 0, 2, A4, 1, 0, 1, A4, 1, 0, 1

	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, D5, 2, 0, 2, D5, 2, 0, 2
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, D5, 2, 0, 2, D5, 2, 0, 2
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, D5, 2, 0, 2, D5, 2, 0, 2
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, D5, 2, 0, 2, D5, 2, 0, 2

	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, D5, 2 ,0, 2, D5, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, D5, 2 ,0, 2, D5, 2, 0, 2
	.byte B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, D5, 2 ,0, 2, D5, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, B4, 2, 0, 2, D5, 2 ,0, 2, D5, 2, 0, 2
	.byte B4, 1, 0, 1, B4, 1, 0, 1, D5, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, D5, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, D5, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, D5, 2, 0, 2
	.byte B4, 1, 0, 1, B4, 1, 0, 1, D5, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, D5, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, D5, 2, 0, 2, B4, 1, 0, 1, B4, 1, 0, 1, D5, 2, 0, 2
	.byte E6, 32

	.byte 0, 0

bazi:
	.byte C5, 2, 0, 2, B4, 2, 0, 2, C5, 2, 0, 4,C6, 1, 0, 1,  C6, 2, B5, 2, A5, 2, G5, 2
	.byte A5, 6, F5, 2, A5, 3, E6, 3, D6, 6, 0, 2, C6, 2, D6, 2, C6, 2, B5, 2, A5, 2
    .byte G5, 6, D5, 2, G5, 3, D6, 3, C6, 8, 0, 6, G5, 4
	.byte F5, 4, G5, 2, A5, 5, 0, 1, A5, 4, G5, 4, A5, 2, B5, 4, D6, 2, C6, 2, B5, 2
	.byte B5, 4, C6, 1, 0, 1, C6, 12, 0, 4, C6, 1, 0, 1, C6, 2, B5, 2, A5, 2, G5, 2
	.byte A5, 6, F5, 2, A5, 3, E6, 3, D6, 6, 0, 2, C6, 2, D6, 2, C6, 2, B5, 2, A5, 2
	.byte G5, 6, D5, 2, G5, 3, D6, 3, C6, 8, 0, 6, A5, 4

    .byte E6, 12, A5, 1, 0, 1, A5, 10, 0, 4, G5, 4
    
    .byte A5, 13, F6, 2, E6, 7, 0, 2, G5, 4 ,B5, 4
	.byte C6, 4, B5, 4, A5, 1, 0, 1, A5, 12, 0, 6
	.byte 0, 0

mon:
	.byte E5, 2, 0, 1, B4, 1, E5, 2, 0, 1, Fs5, 6, B4, 1, 0, 1, E5, 1, 0, 1, Fs5, 1, 0, 1, E5,  1, 0, 1, B4, 1, 0, 1
	.byte B5, 8, A5, 2, G5, 2, Fs5, 6, D5,  4,  0, 2, E5, 1, 0, 1, Fs5, 1, 0, 1, G5, 4
	.byte Fs5, 1, 0, 1, E5, 1, 0, 1, Fs5, 6, D5, 6, B4, 12
	.byte 0, 7, E5, 2, 0, 1, B4, 1, E5, 2, 0, 1, Fs5, 6, B4, 1, 0, 1, E5, 1, 0, 1, Fs5, 1, 0, 1, E5,  1, 0, 1, B4, 1, 0, 1
	.byte E6, 8, D6, 2, C6, 2, B5, 10,  0, 2, A5, 1, 0, 1, B5, 1, 0, 1, C6, 6
	.byte B5, 2, C6, 2, D6, 6, Fs6, 6, E6, 12
	.byte 0, 0

rage:
	.byte Ds5, 2, 0, 2, Ds5, 2, 0, 2, F5, 2, 0 ,2, F5, 2, 0, 2
	.byte G5, 8, 0, 8, Ds5, 2, 0, 2, Ds5, 2, 0, 2, F5, 2, 0, 2, F5, 2, 0, 2
	.byte G5, 8, 0, 8, Ds5, 2, 0, 2, Ds5, 2, 0, 2, F5, 2, 0, 2, F5, 2, 0, 2
	
	.byte G5, 8, G5, 4, Gs5, 4, Gs5, 8, G5, 4, 0, 4
	.byte G5, 4, 0, 4, F5, 4, 0, 4, Ds5, 2, 0, 2, F5, 4, 0, 4, Ds5, 4
	.byte Ds5, 8, 0, 8, Ds5, 2, 0, 2, F5, 4, 0, 4, G5, 4
	.byte G5, 4, 0, 4, G5, 8, F5, 4, Ds5, 8, 0, 4
	
	.byte Ds5, 16, G5, 8, F5, 4, F5, 2, 0, 2
	.byte F5, 8, 0, 8, Ds5, 2, 0, 2, Ds5, 2, 0, 2, F5, 2, 0, 2, F5, 2, 0, 2
	.byte G5, 8, 0, 8, Ds5, 2, 0, 2, Ds5, 2, 0, 2, F5, 2, 0, 2, F5, 2, 0, 2
	.byte G5, 8, 0, 8, Ds5, 2, 0, 2, Ds5, 2, 0, 2, F5, 2, 0, 2, F5, 2, 0, 2

	.byte G5, 8, G5, 4, Gs5, 4, Gs5, 8, G5, 4, 0, 4
	.byte G5, 4, 0, 4, F5, 4, 0, 4, Ds5, 2, 0, 2, F5, 4, 0, 4, Ds5, 4
	.byte Ds5, 8, 0, 8, G5, 8, G5, 4, F5, 4

	.byte F5, 8, Ds5, 4, 0, 4, Ds5, 2, 0, 2, F5, 8, Ds5, 2, 0, 2
	.byte Ds5, 8, As4, 8, Ds5, 8, F5, 8
	.byte Gs5, 4, G5, 8, Ds5, 8, F5, 8, Ds5, 2, Ds5, 1, 0, 1
	.byte Ds5, 16, 0, 16
	
	.byte 0, 0
